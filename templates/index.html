// 1. FUNCIÃ“N PARA VER DETALLE E INSCRITOS
async function verDetalle(id) {
    // Nota: Eliminamos el prompt inicial para que cualquier invitado vea la lista de inmediato
    try {
        const res = await fetch(`${API_URL}/api/partidos/${id}/inscritos`);
        const inscritos = await res.json();
        
        if (inscritos.length === 0) {
            alert("AÃºn no hay nadie inscrito en este encuentro.");
        } else {
            alert("Inscritos actualmente:\n" + inscritos.map(i => "- " + i.nombre_usuario).join("\n"));
        }
    } catch (e) { 
        alert("Error al cargar la lista de inscritos."); 
    }
}

// 2. FUNCIÃ“N PARA DESUNIRSE (Liberar cupo)
async function desunirse(id) {
    const nombre = prompt("Ingresa el nombre con el que te inscribiste para salir de la lista:");
    if (!nombre) return;

    try {
        const res = await fetch(`${API_URL}/api/desunirse`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ partidoId: id, nombre_usuario: nombre })
        });
        const data = await res.json();
        
        if (res.ok) {
            alert(data.mensaje);
            cargarActividades(); // Recargamos para ver el cupo liberado
        } else {
            alert(data.error || "No se pudo procesar la solicitud.");
        }
    } catch (e) { 
        alert("Error al conectar con el servidor."); 
    }
}

// 3. ACTUALIZACIÃ“N DE CARGAR ACTIVIDADES (Con Mapa Corregido)
async function cargarActividades() {
    const contenedor = document.getElementById('lista-actividades');
    try {
        const res = await fetch(`${API_URL}/api/partidos`);
        const datos = await res.json();
        
        if (datos.length === 0) {
            contenedor.innerHTML = "<p>No hay encuentros programados por ahora.</p>";
            return;
        }

        contenedor.innerHTML = datos.map(act => {
            // Corregimos la URL del mapa para que sea dinÃ¡mica segÃºn el lugar
            const mapaUrl = `https://maps.google.com/maps?q=${encodeURIComponent(act.lugar)}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
            
            return `
                <div class="card">
                    <span class="badge">${act.deporte}</span>
                    <h3>${act.deporte} en ${act.lugar}</h3>
                    
                    <div class="map-container" style="height:150px; margin-bottom:10px; border-radius:8px; overflow:hidden;">
                        <iframe width="100%" height="100%" frameborder="0" src="${mapaUrl}"></iframe>
                    </div>

                    <p>ðŸ“… ${new Date(act.fecha_hora).toLocaleString()}</p>
                    <p>ðŸ‘¥ Cupos: ${act.cupos_actuales} / ${act.cupos_totales}</p>
                    
                    <button onclick="unirse(${act.id})" class="btn btn-success">Â¡Me Uno!</button>
                    <button onclick="verDetalle(${act.id})" class="btn" style="background:#17a2b8; color:white; margin-top:5px; border:none; padding:10px; border-radius:5px; width:100%; cursor:pointer;">Ver QuiÃ©nes Van</button>
                    <button onclick="desunirse(${act.id})" class="btn btn-danger" style="margin-top:5px;">Ya no puedo ir</button>
                </div>
            `;
        }).join('');
    } catch (e) { 
        contenedor.innerHTML = "<p>El servidor estÃ¡ despertando... espera unos segundos.</p>"; 
    }
}
